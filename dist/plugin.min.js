"use strict";(()=>{var c=class{constructor(t,e){this.query="";this.$dropdown=null;this.hasFocus=!0;this.editor=t,this.options=Object.assign({source:[],delay:500,queryBy:"name",items:10},e),this.options.insertFrom=this.options.insertFrom||this.options.queryBy,this.renderInput(),this.bindEvents()}renderInput(){let t=`
      <span id="autocomplete">
          <span id="autocomplete-delimiter">${this.options.delimiter||""}</span>
          <span id="autocomplete-searchtext"><span class="dummy">\uFEFF</span></span>
      </span>
    `;this.editor.execCommand("mceInsertContent",!1,t),this.editor.focus();let e=this.editor.selection.dom.select("span#autocomplete-searchtext span")[0];this.editor.selection.select(e),this.editor.selection.collapse(0)}bindEvents(){this.editor.on("keyup",this.rteKeyUp.bind(this)),this.editor.on("keydown",this.rteKeyDown.bind(this),!0),this.editor.on("click",this.rteClicked.bind(this)),document.body.addEventListener("click",this.rteLostFocus.bind(this)),this.editor.getWin().addEventListener("scroll",()=>this.cleanUp(!0))}rteKeyUp(t){switch(t.key){case"ArrowUp":case"ArrowDown":case"Shift":case"Control":case"Alt":break;case"Backspace":this.query===""?this.cleanUp(!0):this.lookup();break;case"Tab":case"Enter":if(this.$dropdown){let e=this.$dropdown.querySelector("li.active");e?(this.select(e.dataset),this.cleanUp(!1)):this.cleanUp(!0)}break;case"Escape":this.cleanUp(!0);break;default:this.lookup()}}rteKeyDown(t){switch(t.key){case"Tab":case"Enter":case"Escape":t.preventDefault();break;case"ArrowUp":t.preventDefault(),this.$dropdown&&this.highlightPreviousResult();break;case"ArrowDown":t.preventDefault(),this.$dropdown&&this.highlightNextResult();break}t.stopPropagation()}rteClicked(t){let e=t.target;this.hasFocus&&e.parentElement?.id!=="autocomplete-searchtext"&&this.cleanUp(!0)}rteLostFocus(){this.hasFocus&&this.cleanUp(!0)}lookup(){let t=this.editor.getBody().querySelector("#autocomplete-searchtext");this.query=t?.textContent?.trim().replace("\uFEFF","")||"",this.$dropdown||this.show(),clearTimeout(this.searchTimeout),this.searchTimeout=window.setTimeout(()=>{let e=typeof this.options.source=="function"?this.options.source(this.query,this.process.bind(this),this.options.delimiter):this.options.source;e&&this.process(e)},this.options.delay)}process(t){if(!this.hasFocus)return;let e=t.filter(this.options.matcher||(n=>n[this.options.queryBy].toLowerCase().includes(this.query.toLowerCase()))),a=(this.options.sorter?this.options.sorter(e):e).slice(0,this.options.items).map((n,d)=>{let o=document.createElement("div");return o.innerHTML=this.options.render?this.options.render(n,d):`<li><a href="javascript:;"><span>${n[this.options.queryBy]}</span></a></li>`,o.innerHTML=o.innerHTML.replace(o.textContent||"",this.options.highlighter?.(o.textContent||"")||o.textContent||""),Object.entries(n).forEach(([p,h])=>{o.dataset[p]=String(h)}),o.outerHTML}).join("");a.length?(this.$dropdown.innerHTML=a,this.$dropdown.style.display="block"):this.$dropdown.style.display="none"}show(){let t=document.createElement("ul");t.className="rte-autocomplete dropdown-menu",t.innerHTML='<li class="loading"></li>';let e=this.offset();t.style.top=`${e.top}px`,t.style.left=`${e.left}px`,document.body.appendChild(t),t.addEventListener("click",s=>this.autoCompleteClick(s)),this.$dropdown=t}autoCompleteClick(t){let e=t.target.closest("li");e&&(this.select(e.dataset),this.cleanUp(!1)),t.stopPropagation(),t.preventDefault()}highlightPreviousResult(){let t=this.$dropdown?.querySelectorAll("li")||[],e=Array.from(t).findIndex(i=>i.classList.contains("active")),s=e===0?t.length-1:e-1;t.forEach(i=>i.classList.remove("active")),t[s]?.classList.add("active")}highlightNextResult(){let t=this.$dropdown?.querySelectorAll("li")||[],e=Array.from(t).findIndex(i=>i.classList.contains("active")),s=e===t.length-1?0:e+1;t.forEach(i=>i.classList.remove("active")),t[s]?.classList.add("active")}select(t){this.editor.focus();let e=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(e),this.editor.execCommand("mceInsertContent",!1,this.options.insert?this.options.insert(t):`<span>${t[this.options.insertFrom||this.options.queryBy]}</span>&nbsp;`)}offset(){let t=this.editor.getContainer().getBoundingClientRect(),e=this.editor.getContentAreaContainer().getBoundingClientRect(),s=this.editor.dom.select("span#autocomplete")[0].getBoundingClientRect();return{top:t.top+e.top+s.top+this.editor.selection.getNode().offsetHeight-this.editor.getDoc().scrollTop+5,left:t.left+e.left+s.left}}cleanUp(t){if(this.unbindEvents(),this.hasFocus=!1,this.$dropdown?.remove(),this.$dropdown=null,t){let e=this.query,s=this.editor.dom.select("span#autocomplete")[0];if(!s)return;let i=document.createElement("p");i.textContent=this.options.delimiter+e,this.editor.dom.replace(i,s),this.editor.selection.select(i),this.editor.selection.collapse()}}unbindEvents(){document.body.removeEventListener("click",this.rteLostFocus.bind(this)),this.editor.off("keyup",this.rteKeyUp.bind(this)),this.editor.off("keydown",this.rteKeyDown.bind(this)),this.editor.off("click",this.rteClicked.bind(this))}},l="mention",u=()=>({name:l,author:"Surya Pratap",url:"https://github.com/suryapratap/tinymce-mention-plugin"});function m(){window.tinymce.PluginManager.add(l,function(r){console.log("register mention plugin");let t,e=r.getParam(l);e.delimiter=e.delimiter?Array.isArray(e.delimiter)?e.delimiter:[e.delimiter]:["@"];function s(){let i=r.selection.getRng(),a=i.startOffset;return!(i.startContainer?.dataset||"").toString().charAt(a-1).trim().length}return console.log("register keypress for mention plugin"),r.on("keypress",i=>{e?.delimiter?.includes(i.key)&&s()&&(!t||!t?.hasFocus)&&(i.preventDefault(),t=new c(r,{delimiter:i.key,...e}))}),{getMetadata:u}})}var y=m();})();
